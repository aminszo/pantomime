const gameDefaults={groups:{1:{name:"گروه یک",score:0},2:{name:"گروه دو",score:0}},currentRound:1,totalRounds:3,currentGroup:1,winner:null,currentChoice:{genre:null,genre_fa:null,score:null,type:null},addition:{wordChangeChances:2,wordChangeScore:0,faults:0},isGameStarted:!1};let game={};const genres={word:{meta:{parentClass:"col",scores:[1,2,3],playTime:{1:45,2:60,3:75}},content:{thing:{name:"اشیا",color:"orange"},food:{name:"غذا",color:"green"},animal:{name:"حیوان",color:"blue"},sport:{name:"ورزش",color:"pink"},place:{name:"مکان",color:"reddish-brown"},famous:{name:"مشاهیر",color:"light-blue"},book:{name:"کتاب",color:"dark-cyan"},film:{name:"فیلم",color:"orange-red"},city:{name:"شهر و کشور",color:"purple"}}},proverb:{meta:{parentClass:"col-12",scores:[2,4,6],playTime:{2:90,4:105,6:120}},content:{proverb:{name:"ضرب‌المثل",color:"light-pink"}}},rush:{meta:{parentClass:"col-12",scores:["نامحدود"],playTime:180},content:{rush:{name:"سرعتی",color:"green"}}}};let countdown,timeLeft,currentWord={};const wordsBagDefaults={words:{},count:0,current:0,usedWords:new Set,correctWords:[]};let wordsBag=structuredClone(wordsBagDefaults);const numberStrings={1:"اول",2:"دوم",3:"سوم",4:"چهارم",5:"پنجم",6:"ششم"},optionsBoard=document.getElementById("game-options-board"),scoreBoard=document.getElementById("score-board"),selectorBoard=document.getElementById("selector-board"),genreSelector=document.getElementById("genre-selector"),scoreSelector=document.getElementById("score-selector"),gameBoard=document.getElementById("game-board"),resultScreen=document.getElementById("result-screen"),rushBoard=document.getElementById("rush-board"),rush_resultScreen=document.getElementById("rush-result-screen"),allBoards=[optionsBoard,scoreBoard,selectorBoard,gameBoard,resultScreen,rushBoard,rush_resultScreen],scoreBoardTableBody=document.querySelector("#score-board table tbody"),roundsIndcatorElement=document.getElementById("rounds-indicator"),turnIndicator=document.getElementById("current-group-indicator"),wordContainer=document.getElementById("word-container"),wordInfoContainer=document.getElementById("word-genre-and-score"),timerElement=document.getElementById("timer"),winnerIndicator=document.getElementById("winner-indicator"),confirmRoundStartModal=new bootstrap.Modal(document.getElementById("confirm-round-start")),confirmSelectionQuestion=document.getElementById("confirm-round-start-question"),renameGroupModal=new bootstrap.Modal(document.getElementById("rename-group-modal")),setGameOptionsBtn=document.getElementById("set-game-options-btn"),startRoundBtn=document.getElementById("start-round-btn"),startTimerBtn=document.getElementById("start-timer-btn"),stopTimerBtn=document.getElementById("stop-timer-btn"),confirmSelectionBtn=document.getElementById("confirm-selection-btn"),changeWordBtn=document.getElementById("change-word-btn"),correctBtn=document.getElementById("correct-btn"),wrongBtn=document.getElementById("wrong-btn"),continueBtn=document.getElementById("continue-btn"),resetGameBtn=document.getElementById("reset-game-btn"),rush_turnIndicator=document.getElementById("current-group-indicator-rush"),rush_timerElement=document.getElementById("timer-rush"),rush_startTimerBtn=document.getElementById("start-timer-btn-rush"),rush_stopTimerBtn=document.getElementById("stop-timer-btn-rush"),rush_correctBtn=document.getElementById("correct-btn-rush"),rush_nextWordBtn=document.getElementById("next-word-btn"),rush_perviousWordBtn=document.getElementById("previus-word-btn"),rush_wordContainer=document.getElementById("word-container-rush"),rush_wordInfoContainer=document.getElementById("word-genre-and-score-rush"),countdownMusic=document.getElementById("countdown-music"),endCountdownMusic=document.getElementById("end-countdown-music"),csrf_token=document.getElementById("csrf-token").innerText;function savegame(){localStorage.setItem("pantomimegamestate",JSON.stringify(game))}function loadgame(){const e=localStorage.getItem("pantomimegamestate");e?game=JSON.parse(e):resetgame()}function resetgame(){game=structuredClone(gameDefaults),savegame(),switchTo(optionsBoard)}function show(e){Array.isArray(e)?e.forEach((e=>{e.classList.remove("hidden")})):e.classList.remove("hidden")}function hide(e){Array.isArray(e)?e.forEach((e=>{e.classList.add("hidden")})):e.classList.add("hidden")}function switchTo(e,t=null,n=null){runIfIsFunction(t),hide(allBoards),show(e),runIfIsFunction(n)}function startCountdown(e=null,t){timeLeft=--currentWord.playTime,t.innerText=formatTime(timeLeft),countdownMusic.play(),countdown=setInterval((function(){t.innerText=formatTime(--timeLeft),0===timeLeft&&stopCountdown(e)}),1e3)}function stopCountdown(e=null){clearInterval(countdown),countdownMusic.pause(),countdownMusic.currentTime=0,endCountdownMusic.play(),runIfIsFunction(e)}function formatTime(e){const t=Math.floor(e/60),n=e%60;return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function runIfIsFunction(e){"function"==typeof e&&e()}function updateScoreBoard(){roundsIndcatorElement.innerHTML=`دور ${game.currentRound} از ${game.totalRounds}`,scoreBoardTableBody.innerHTML="";for(const[e,t]of Object.entries(game.groups)){const n=document.createElement("tr"),r=document.createElement("td"),o=document.createElement("i");o.classList.add("bi","bi-pencil-square","rename-btn"),o.dataset.groupId=e,r.appendChild(o),n.appendChild(r);const c=document.createElement("td");c.textContent=t.name,null!=game.winner?game.winner==e&&(c.textContent+=" 🏆",n.classList.add("table-success")):e==game.currentGroup&&(c.textContent+=" ▶️",n.classList.add("table-active")),n.appendChild(c);const d=document.createElement("td");d.textContent=t.score,n.appendChild(d),scoreBoardTableBody.appendChild(n)}document.querySelectorAll(".rename-btn").forEach((e=>{e.addEventListener("click",(function(){const e=document.getElementById("rename-group-input"),t=this.dataset.groupId;e.dataset.groupId=t,e.value=game.groups[t].name,renameGroupModal.show()}))})),null!=game.winner?(hide(startRoundBtn),show(winnerIndicator),"tie"==game.winner?winnerIndicator.textContent="نتیجه : مساوی!":winnerIndicator.textContent=`برنده بازی : ${game.groups[game.winner].name} !`):(show(startRoundBtn),hide(winnerIndicator))}function renderSelectorBoard(){genreSelector.innerHTML="";for(const[e,t]of Object.entries(genres))for(const[n,r]of Object.entries(t.content)){const o=document.createElement("div");o.classList.add(t.meta.parentClass);const c=document.createElement("div");c.classList.add("genre",`${r.color}-bg`,"my-3"),c.dataset.genre=n,c.dataset.type=e,c.dataset.name_fa=r.name,c.textContent=r.name,o.appendChild(c),genreSelector.appendChild(o)}document.querySelectorAll(".genre").forEach((e=>{e.addEventListener("click",(function(){game.currentChoice.genre=this.dataset.genre,game.currentChoice.genre_fa=this.dataset.name_fa,game.currentChoice.type=this.dataset.type,renderScoreSelector()}))}))}function renderScoreSelector(){const e=document.getElementById("score-selector-row");e.innerHTML="";const t=genres[game.currentChoice.type].meta.scores;for(const n in t){const r=document.createElement("div");r.classList.add("col");const o=document.createElement("div");o.classList.add("score"),o.dataset.score=t[n],o.innerText=t[n],r.appendChild(o),e.appendChild(r)}document.querySelectorAll(".score").forEach((e=>{e.addEventListener("click",(function(){game.currentChoice.score=this.dataset.score,confirmSelectionQuestion.innerText=`انتخاب ${game.currentChoice.genre_fa} با امتیاز ${game.currentChoice.score}`,confirmRoundStartModal.show()}))})),show(scoreSelector)}function getNewWord(){fetch(`word/random/${game.currentChoice.genre}/${game.currentChoice.score}`).then((e=>e.json())).then((e=>{currentWord=e,currentWord.playTime=genres[currentWord.type].meta.playTime[currentWord.score],show(startTimerBtn),switchTo(gameBoard,updateGameBoard)})).catch((e=>{console.error("Error fetching random word:",e)}))}function updateGameBoard(){turnIndicator.innerHTML=game.groups[game.currentGroup].name,wordContainer.innerText=currentWord.content,wordInfoContainer.innerText=`${game.currentChoice.genre_fa} - ${currentWord.score} امتیاز`,timerElement.innerHTML=formatTime(currentWord.playTime),game.addition.wordChangeChances>0?show(changeWordBtn):hide(changeWordBtn)}function onRoundFinish(){show([correctBtn,wrongBtn]),hide(stopTimerBtn)}function calculateScore(e){let t=0,n=0,r=game.addition.wordChangeScore;e&&(t=currentWord.score,n=Math.floor(timeLeft/30)),game.groups[game.currentGroup].score+=t+n+r,game.addition=JSON.parse(JSON.stringify(gameDefaults.addition)),updateResultScreen(t,n,r),switchTo(resultScreen),goToNextRound()}function updateResultScreen(e,t=0,n){const r=e+t+n;document.getElementById("result-word-score").innerHTML=e,document.getElementById("result-time-score").innerHTML=t,document.getElementById("result-word-change-score").innerHTML=n,document.getElementById("result-total-score").innerHTML=r}function goToNextRound(){game.currentGroup===Object.keys(game.groups).length?(game.currentGroup=1,game.currentRound++):game.currentGroup++,game.currentRound>game.totalRounds&&(game.currentRound--,determineWinner()),savegame()}function determineWinner(){let e=Number.NEGATIVE_INFINITY,t=null,n=!1;for(const r in game.groups)if(game.groups.hasOwnProperty(r)){const o=game.groups[r];o.score>e?(e=o.score,t=r,n=!1):o.score===e&&(n=!0)}n&&(t="tie"),game.winner=t,savegame()}function sendDataToServer(e){const t={data:e,_token:csrf_token};$.ajax({type:"POST",url:"save-data",data:t,dataType:"json",success:function(e){console.log("Data saved successfully:",e),game.wordsUsed=[]},error:function(e,t,n){console.error("Error saving data:",n)}})}function getWordsBag(){fetch("words-bag").then((e=>e.json())).then((e=>{wordsBag.words=e,wordsBag.count=Object.keys(e).length-1,currentWord.playTime=genres.rush.meta.playTime,show(rush_startTimerBtn),switchTo(rushBoard,updateRushBoard)})).catch((e=>{console.error("Error fetching words bag:",e)}))}function updateRushBoard(){rush_turnIndicator.innerHTML=game.groups[game.currentGroup].name,rush_timerElement.innerHTML=formatTime(currentWord.playTime)}function rush_showCurrentWord(){const e=wordsBag.words[wordsBag.current];rush_wordContainer.innerHTML=e.content,rush_wordInfoContainer.innerHTML=`${e.genre_fa} ${e.score} امتیازی`,wordsBag.usedWords.add(e.id)}function rush_onRoundFinish(){hide([rush_correctBtn,rush_nextWordBtn,rush_perviousWordBtn,rush_stopTimerBtn]),rush_wordContainer.innerHTML=rush_wordInfoContainer.innerHTML="";let e=0;e=wordsBag.correctWords.reduce(((e,t)=>e+t.score),0),game.groups[game.currentGroup].score+=e,goToNextRound(),rush_renderResultScreen(e),wordsBag=structuredClone(wordsBagDefaults)}function rush_renderResultScreen(e){const t=document.getElementById("correct-words-list");for(word of(document.getElementById("total-score-rush").innerHTML=`مجموع امتیاز : ${e}`,t.innerHTML="",wordsBag.correctWords)){const e=document.createElement("p");e.innerHTML=`${word.content} : ${word.score}`,t.appendChild(e)}switchTo(rush_resultScreen)}setGameOptionsBtn.addEventListener("click",(()=>{game.totalRounds=document.getElementById("rounds-count-input").value;const e=document.getElementById("groups-count-input").value;for(let t=1;t<=e;t++)game.groups[t]={name:`گروه ${numberStrings[t]}`,score:0};game.isGameStarted=!0,switchTo(scoreBoard,updateScoreBoard,savegame)})),document.getElementById("confirm-rename-btn").addEventListener("click",(()=>{const e=document.getElementById("rename-group-input"),t=e.dataset.groupId;game.groups[t].name=e.value,savegame(),updateScoreBoard(),renameGroupModal.hide()})),startRoundBtn.addEventListener("click",(()=>{switchTo(selectorBoard,renderSelectorBoard)})),confirmSelectionBtn.addEventListener("click",(()=>{["word","proverb"].includes(game.currentChoice.type)?getNewWord():"rush"===game.currentChoice.type&&getWordsBag(),hide(scoreSelector),confirmRoundStartModal.hide()})),startTimerBtn.addEventListener("click",(()=>{hide([startTimerBtn,changeWordBtn]),show(stopTimerBtn),startCountdown(onRoundFinish,timerElement)})),stopTimerBtn.addEventListener("click",(()=>{stopCountdown(onRoundFinish)})),changeWordBtn.addEventListener("click",(()=>{game.addition.wordChangeChances--,game.addition.wordChangeScore--,getNewWord()})),correctBtn.addEventListener("click",(()=>{hide([correctBtn,wrongBtn]),calculateScore(!0)})),wrongBtn.addEventListener("click",(()=>{hide([correctBtn,wrongBtn]),calculateScore(!1)})),document.querySelectorAll(".continue-btn").forEach((e=>{e.addEventListener("click",(()=>{switchTo(scoreBoard,updateScoreBoard)}))})),resetGameBtn.addEventListener("click",(()=>{confirm("میخواهید بازی را ریست کنید!؟")&&resetgame()})),rush_startTimerBtn.addEventListener("click",(()=>{rush_showCurrentWord(),hide([rush_startTimerBtn]),show([rush_correctBtn,rush_nextWordBtn,rush_perviousWordBtn,rush_stopTimerBtn]),startCountdown(rush_onRoundFinish,rush_timerElement)})),rush_stopTimerBtn.addEventListener("click",(()=>{confirm("پایان اجرا؟")&&stopCountdown(rush_onRoundFinish)})),rush_nextWordBtn.addEventListener("click",(()=>{do{wordsBag.current==wordsBag.count?wordsBag.current=0:wordsBag.current++}while(!(wordsBag.current in wordsBag.words));rush_showCurrentWord()})),rush_perviousWordBtn.addEventListener("click",(()=>{do{0==wordsBag.current?wordsBag.current=wordsBag.count:wordsBag.current--}while(!(wordsBag.current in wordsBag.words));rush_showCurrentWord()})),rush_correctBtn.addEventListener("click",(()=>{wordsBag.correctWords.push(wordsBag.words[wordsBag.current]),delete wordsBag.words[wordsBag.current],rush_nextWordBtn.click()})),loadgame(),game.isGameStarted?updateScoreBoard():switchTo(optionsBoard);